<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÏÑ†Ìò∏ÎÑ§ Ï¶êÍ±∞Ïö¥ Ïú∑ÎÜÄÏù¥</title>
    <style>
        :root {
            --bg-color: #f0e6d2;
            --board-line: #5d4037;
            --red-team: #e74c3c;
            --blue-team: #3498db;
            --node-size: 14px;
            --piece-size: 28px;
        }

        body {
            font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            background-color: #222;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            color: white;
            user-select: none; /* ÌÖçÏä§Ìä∏ ÏÑ†ÌÉù Î∞©ÏßÄ */
        }

        /* ÏÑ§Ï†ï ÌôîÎ©¥ */
        #setup-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            gap: 20px;
            z-index: 100;
            background: #222;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        h1 { 
            margin-bottom: 10px; 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .title-icon {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }


        .input-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            font-size: 1.1rem;
            width: 100%;
        }

        .settings-container {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 15px;
            width: 80%;
            max-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .team-settings {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 15px;
        }

        .team-setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }

        select {
            padding: 8px;
            border-radius: 6px;
            border: none;
            background: #444;
            color: white;
            font-size: 1rem;
            width: 120px;
        }

        input[type="number"] {
            padding: 8px;
            font-size: 1.1rem;
            width: 50px;
            text-align: center;
            border-radius: 8px;
            border: none;
            background: #444;
            color: white;
        }

        button {
            padding: 12px 24px;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background-color: #2ecc71;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 0 #27ae60;
            transition: transform 0.1s;
        }
        button:active {
            box-shadow: 0 2px 0 #27ae60;
            transform: translateY(2px);
        }

        /* Í≤åÏûÑ ÌôîÎ©¥ */
        #game-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 100%;
            padding-top: 20px;
            box-sizing: border-box;
        }

        .header {
            display: flex;
            justify-content: space-between;
            width: 90%;
            max-width: 400px;
            margin-bottom: 15px;
            align-items: center;
        }

        .turn-indicator {
            font-size: 1.2rem;
            font-weight: bold;
            padding: 8px 20px;
            border-radius: 20px;
            background: #444;
            transition: all 0.3s;
        }

        /* Ïú∑Ìåê ÎîîÏûêÏù∏ */
        .board-container {
            position: relative;
            width: 90vw;
            height: 90vw;
            max-width: 400px;
            max-height: 400px;
            background-color: var(--bg-color);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }

        /* Ïú∑Ìåê ÏÑ† Í∑∏Î¶¨Í∏∞ (SVG ÌôúÏö©) */
        .board-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* ÌÅ¥Î¶≠ ÌÜµÍ≥º */
        }
        
        /* ÎßêÌåê Ï†ê (ÎÖ∏Îìú) */
        .node {
            position: absolute;
            width: var(--node-size);
            height: var(--node-size);
            background-color: var(--bg-color);
            border: 2px solid var(--board-line);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            cursor: pointer;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            color: #5d4037;
            font-weight: bold;
        }

        /* ÌÖçÏä§Ìä∏Í∞Ä ÏûàÎäî ÎÖ∏Îìú */
        .node.text-node {
            width: 36px;
            height: 36px;
            border-width: 2px;
            background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 15;
        }
        
        .node.start-node {
            border-color: #2ecc71;
            color: #27ae60;
        }

        .node.finish-node {
            border-color: #e74c3c;
            color: #c0392b;
        }
        
        /* ÌÑ∞Ïπò ÏòÅÏó≠ ÌôïÏû•ÏùÑ ÏúÑÌïú Í∞ÄÏÉÅ ÏöîÏÜå */
        .node::after {
            content: '';
            position: absolute;
            top: -10px; left: -10px; right: -10px; bottom: -10px;
        }

        /* ÌÅ∞ Ï†ê (ÏΩîÎÑà, Ï§ëÏïô) */
        .node.large {
            width: calc(var(--node-size) * 1.8);
            height: calc(var(--node-size) * 1.8);
            border-width: 3px;
        }

        /* Îßê (Piece) */
        .piece {
            width: var(--piece-size);
            height: var(--piece-size);
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 3px 6px rgba(0,0,0,0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px; /* Ïù¥Î™®ÏßÄ ÌÅ¨Í∏∞ */
            font-weight: bold;
            color: white;
            position: absolute;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 20;
            cursor: pointer;
        }

        .piece-num {
            position: absolute;
            bottom: -2px;
            right: -2px;
            font-size: 9px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 1px 3px;
            border-radius: 4px;
            line-height: 1;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .piece.red { background-color: var(--red-team); }
        .piece.blue { background-color: var(--blue-team); }
        
        .piece.selected {
            border: 3px solid #f1c40f;
            transform: scale(1.3);
            z-index: 100 !important;
            box-shadow: 0 0 15px #f1c40f;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(241, 196, 15, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(241, 196, 15, 0); }
            100% { box-shadow: 0 0 0 0 rgba(241, 196, 15, 0); }
        }

        /* ÎåÄÍ∏∞Ïã§ */
        .waiting-area {
            display: flex;
            width: 90%;
            max-width: 400px;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 10px;
        }
        
        .team-box {
            display: flex;
            flex-direction: column;
            width: 48%;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid transparent;
            transition: all 0.3s;
        }

        .team-box.active {
            background-color: rgba(255,255,255,0.15);
            border-color: rgba(255,255,255,0.5);
            box-shadow: 0 0 15px rgba(255,255,255,0.1);
        }

        .team-header {
            padding: 5px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9rem;
            color: white;
        }

        .team-sections {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .section {
            padding: 5px;
            min-height: 40px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .section-label {
            width: 100%;
            font-size: 0.7rem;
            color: #aaa;
            text-align: center;
            margin-bottom: 2px;
        }

        .section.waiting {
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .section.finished {
            background: rgba(255,255,255,0.05);
        }

        /* ÌïòÎã® Ïª®Ìä∏Î°§ */
        .controls {
            display: flex;
            gap: 15px;
            width: 90%;
            max-width: 400px;
            justify-content: center;
        }

        .btn-reset { background-color: #e74c3c; box-shadow: 0 4px 0 #c0392b; font-size: 0.9rem; padding: 8px 16px;}
        .btn-reset:active { box-shadow: 0 2px 0 #c0392b; }

        .btn-undo { 
            background-color: #f39c12; 
            box-shadow: 0 4px 0 #d35400; 
            font-size: 0.9rem; 
            padding: 8px 16px;
            margin-right: 10px;
        }
        .btn-undo:active { box-shadow: 0 2px 0 #d35400; transform: translateY(2px); }

        .btn-pass { 
            background-color: #3498db; 
            box-shadow: 0 4px 0 #2980b9; 
            flex-grow: 1;
            font-size: 1.2rem;
        }
        .btn-pass:active { box-shadow: 0 2px 0 #2980b9; }

        /* Îßê Í≤πÏπ® ÌëúÏãú Î±ÉÏßÄ */
        .piece-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #222;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid white;
            z-index: 25;
        }

        /* ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 30px;
            padding: 16px;
            position: fixed;
            z-index: 200;
            bottom: 30px;
            font-size: 17px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }

        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }
    </style>
</head>
<body>

    <!-- ÏÑ§Ï†ï ÌôîÎ©¥ -->
    <div id="setup-screen">
        <h1>
            <img src="yut-icon.png" alt="Ïú∑" class="title-icon">
            <div style="text-align: left; line-height: 1.3;">ÏÑ†Ìò∏ÎÑ§<br>Ï¶êÍ±∞Ïö¥ Ïú∑ÎÜÄÏù¥</div>
        </h1>
        
        <div class="settings-container">
            <div class="input-group">
                <label for="piece-count">Îßê Í∞úÏàò</label>
                <input type="number" id="piece-count" value="4" min="1" max="8">
            </div>

            <div class="team-settings">
                <div class="team-setting-row" style="color: var(--red-team)">
                    <label>Îπ®Í∞ÑÌåÄ</label>
                    <select id="red-icon">
                        <option value="default">Í∏∞Î≥∏ (ÏõêÌòï)</option>
                        <option value="rabbit">ÌÜ†ÎÅº üê∞</option>
                        <option value="horse">Îßê üê¥</option>
                        <option value="pig">ÎèºÏßÄ üê∑</option>
                        <option value="duck">Ïò§Î¶¨ ü¶Ü</option>
                    </select>
                </div>
                <div class="team-setting-row" style="color: var(--blue-team)">
                    <label>ÌååÎûÄÌåÄ</label>
                    <select id="blue-icon">
                        <option value="default">Í∏∞Î≥∏ (ÏõêÌòï)</option>
                        <option value="rabbit">ÌÜ†ÎÅº üê∞</option>
                        <option value="horse">Îßê üê¥</option>
                        <option value="pig">ÎèºÏßÄ üê∑</option>
                        <option value="duck">Ïò§Î¶¨ ü¶Ü</option>
                    </select>
                </div>
            </div>
        </div>

        <button onclick="startGame()">Í≤åÏûÑ ÏãúÏûë</button>
    </div>

    <!-- Í≤åÏûÑ ÌôîÎ©¥ -->
    <div id="game-screen">
        <div class="header">
            <div id="turn-display" class="turn-indicator">Îπ®Í∞ÑÌåÄ Ï∞®Î°Ä</div>
            <div>
                <button class="btn-undo" onclick="undo()">Î¨¥Î•¥Í∏∞</button>
                <button class="btn-reset" onclick="resetGame()">Î¶¨ÏÖã</button>
            </div>
        </div>

        <div class="board-container" id="board">
            <!-- SVG ÏÑ† -->
            <svg class="board-lines" viewBox="0 0 100 100">
                <!-- ÌÖåÎëêÎ¶¨ -->
                <rect x="10" y="10" width="80" height="80" fill="none" stroke="#5d4037" stroke-width="2"/>
                <!-- ÎåÄÍ∞ÅÏÑ† -->
                <line x1="10" y1="10" x2="90" y2="90" stroke="#5d4037" stroke-width="2"/>
                <line x1="90" y1="10" x2="10" y2="90" stroke="#5d4037" stroke-width="2"/>
            </svg>
            <!-- ÎÖ∏ÎìúÎì§ÏùÄ JSÎ°ú ÏÉùÏÑ±Îê® -->
        </div>

        <div class="waiting-area">
            <div id="team-red" class="team-box" style="border-top: 3px solid var(--red-team)">
                <div class="team-header" style="color: var(--red-team)">Îπ®Í∞ÑÌåÄ</div>
                <div class="team-sections">
                    <div class="section waiting" id="waiting-red">
                        <div class="section-label">ÎåÄÍ∏∞</div>
                    </div>
                    <div class="section finished" id="finished-red">
                        <div class="section-label">ÏôÑÏ£º</div>
                    </div>
                </div>
            </div>
            <div id="team-blue" class="team-box" style="border-top: 3px solid var(--blue-team)">
                <div class="team-header" style="color: var(--blue-team)">ÌååÎûÄÌåÄ</div>
                <div class="team-sections">
                    <div class="section waiting" id="waiting-blue">
                        <div class="section-label">ÎåÄÍ∏∞</div>
                    </div>
                    <div class="section finished" id="finished-blue">
                        <div class="section-label">ÏôÑÏ£º</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn-pass" onclick="nextTurn()">ÌÑ¥ ÎÑòÍ∏∞Í∏∞</button>
        </div>
    </div>

    <div id="toast">Î©îÏãúÏßÄ</div>

    <script>
        // Í≤åÏûÑ ÏÉÅÌÉú
        let gameState = {
            redPieces: [], 
            bluePieces: [],
            currentTurn: 'red', // 'red' or 'blue'
            selectedPieceId: null,
            pieceCount: 4,
            redIcon: 'default',
            blueIcon: 'default'
        };

        let gameHistory = []; // Î¨¥Î•¥Í∏∞Î•º ÏúÑÌïú ÌûàÏä§ÌÜ†Î¶¨ Ïä§ÌÉù

        const iconMap = {
            'default': '',
            'rabbit': 'üê∞',
            'horse': 'üê¥',
            'pig': 'üê∑',
            'duck': 'ü¶Ü'
        };

        // Î≥¥Îìú Ï¢åÌëú Ï†ïÏùò (0~100% Í∏∞Ï§Ä)
        // 0:Ï∂úÎ∞ú, 1~20: ÌÖåÎëêÎ¶¨ Î∞òÏãúÍ≥Ñ, 21~29: ÎÇ¥Î∂Ä
        // 0Î≤à(Ï∂úÎ∞ú)Í≥º 29Î≤à(ÎèÑÏ∞©)ÏùÑ Î∂ÑÎ¶¨
        const nodes = [
            {x: 90, y: 90, type: 'text-node start-node', label: 'Ï∂úÎ∞ú'}, // 0 (Ï∂úÎ∞ú)
            {x: 90, y: 74}, {x: 90, y: 58}, {x: 90, y: 42}, {x: 90, y: 26}, // 1~4
            {x: 90, y: 10, type: 'large'}, // 5 (Ïö∞ÏÉÅ)
            {x: 74, y: 10}, {x: 58, y: 10}, {x: 42, y: 10}, {x: 26, y: 10}, // 6~9
            {x: 10, y: 10, type: 'large'}, // 10 (Ï¢åÏÉÅ)
            {x: 10, y: 26}, {x: 10, y: 42}, {x: 10, y: 58}, {x: 10, y: 74}, // 11~14
            {x: 10, y: 90, type: 'large'}, // 15 (Ï¢åÌïò)
            {x: 26, y: 90}, {x: 42, y: 90}, {x: 58, y: 90}, {x: 74, y: 90}, // 16~19
            
            // ÎåÄÍ∞ÅÏÑ† Î∞è Ï§ëÏïô
            // Ïö∞ÏÉÅ(5) -> Ï§ëÏïô(22)
            {x: 76, y: 24}, {x: 63, y: 37}, // 20, 21
            // Ï§ëÏïô
            {x: 50, y: 50, type: 'large'}, // 22 (Î∞©)
            // Ï§ëÏïô(22) -> Ï¢åÌïò(15)
            {x: 37, y: 63}, {x: 24, y: 76}, // 23, 24
            
            // Ï¢åÏÉÅ(10) -> Ï§ëÏïô(22)
            {x: 24, y: 24}, {x: 37, y: 37}, // 25, 26
            // Ï§ëÏïô(22) -> Ïö∞Ìïò(0)
            {x: 63, y: 63}, {x: 76, y: 76},  // 27, 28
            
            // ÎèÑÏ∞© ÎÖ∏Îìú (Î≥ÑÎèÑ) - Ï∂úÎ∞úÏ†ê ÏòÜÏóê Î∞∞Ïπò
            {x: 102, y: 90, type: 'text-node finish-node', label: 'ÎèÑÏ∞©'} // 29 (ÎèÑÏ∞©)
        ];

        function initBoard() {
            const board = document.getElementById('board');
            // Í∏∞Ï°¥ ÎÖ∏Îìú ÏÇ≠Ï†ú (SVG Ï†úÏô∏)
            const oldNodes = document.querySelectorAll('.node');
            oldNodes.forEach(n => n.remove());

            nodes.forEach((pos, index) => {
                const node = document.createElement('div');
                node.className = `node ${pos.type || ''}`;
                node.style.left = pos.x + '%';
                node.style.top = pos.y + '%';
                if (pos.label) node.innerText = pos.label;
                node.dataset.index = index;
                node.onclick = () => handleNodeClick(index);
                board.appendChild(node);
            });
        }

        function saveHistory() {
            // ÌòÑÏû¨ ÏÉÅÌÉúÎ•º ÍπäÏùÄ Î≥µÏÇ¨ÌïòÏó¨ Ï†ÄÏû•
            gameHistory.push(JSON.parse(JSON.stringify(gameState)));
            // ÌûàÏä§ÌÜ†Î¶¨ Í∞úÏàò Ï†úÌïú (ÏÑ†ÌÉù ÏÇ¨Ìï≠, Î©îÎ™®Î¶¨ Í¥ÄÎ¶¨ ÏúÑÌï¥ 50Í∞ú Ï†ïÎèÑ Ïú†ÏßÄ)
            if (gameHistory.length > 50) gameHistory.shift();
        }

        function undo() {
            if (gameHistory.length === 0) {
                showToast("Îçî Ïù¥ÏÉÅ Î¨¥Î•º Ïàò ÏóÜÏäµÎãàÎã§.");
                return;
            }
            
            if(confirm('Î∞©Í∏à Ìïú ÌñâÎèôÏùÑ Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                const prevState = gameHistory.pop();
                gameState = prevState;
                renderGame();
                showToast("Î¨¥Î•¥Í∏∞ ÏôÑÎ£å!");
            }
        }

        function startGame() {
            const countInput = document.getElementById('piece-count');
            gameState.pieceCount = parseInt(countInput.value) || 4;
            
            // ÏïÑÏù¥ÏΩò ÏÑ§Ï†ï Ï†ÄÏû•
            gameState.redIcon = document.getElementById('red-icon').value;
            gameState.blueIcon = document.getElementById('blue-icon').value;

            // Îßê Ï¥àÍ∏∞Ìôî
            gameState.redPieces = Array.from({length: gameState.pieceCount}, (_, i) => ({
                id: `r${i}`, team: 'red', location: -1
            }));
            gameState.bluePieces = Array.from({length: gameState.pieceCount}, (_, i) => ({
                id: `b${i}`, team: 'blue', location: -1
            }));

            gameState.currentTurn = 'red';
            gameState.selectedPieceId = null;
            
            gameHistory = []; // ÌûàÏä§ÌÜ†Î¶¨ Ï¥àÍ∏∞Ìôî

            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            
            initBoard();
            renderGame();
            showToast("Í≤åÏûÑÏùÑ ÏãúÏûëÌï©ÎãàÎã§! Îπ®Í∞ÑÌåÄ Î®ºÏ†Ä!");
        }

        function resetGame() {
            if(confirm('Í≤åÏûÑÏùÑ Î¶¨ÏÖãÌïòÏãúÍ≤†ÏäµÎãàÍπå? Î™®Îì† ÏßÑÌñâ ÏÉÅÌô©Ïù¥ ÏÇ¨ÎùºÏßëÎãàÎã§.')) {
                document.getElementById('setup-screen').style.display = 'flex';
                document.getElementById('game-screen').style.display = 'none';
            }
        }

        function nextTurn() {
            saveHistory(); // ÌÑ¥ ÎÑòÍ∏∞Í∏∞ Ï†Ñ ÏÉÅÌÉú Ï†ÄÏû•
            gameState.currentTurn = gameState.currentTurn === 'red' ? 'blue' : 'red';
            gameState.selectedPieceId = null;
            renderGame();
            
            const teamName = gameState.currentTurn === 'red' ? 'Îπ®Í∞ÑÌåÄ' : 'ÌååÎûÄÌåÄ';
            showToast(`${teamName} Ï∞®Î°ÄÏûÖÎãàÎã§.`);
        }

        function handlePieceClick(pieceId, event) {
            event.stopPropagation(); // ÎÖ∏Îìú ÌÅ¥Î¶≠ Î∞©ÏßÄ
            
            const team = pieceId.startsWith('r') ? 'red' : 'blue';
            const pieces = team === 'red' ? gameState.redPieces : gameState.bluePieces;
            const clickedPiece = pieces.find(p => p.id === pieceId);

            // 1. ÎÇ¥ ÌÑ¥ Ï≤¥ÌÅ¨
            if (team !== gameState.currentTurn) {
                // ÎßåÏïΩ Ïù¥ÎØ∏ ÎÇ¥ ÎßêÏù¥ ÏÑ†ÌÉùÎêòÏñ¥ ÏûàÍ≥†, ÌÅ¥Î¶≠Ìïú Í≤å Ï†ÅÍµ∞ ÎßêÏù¥ÎùºÎ©¥? -> Ïû°Í∏∞ ÏãúÎèÑ Í∞ÄÎä•!
                // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÎßêÏù¥ ÏûàÍ≥†, ÌÅ¥Î¶≠Îêú ÎßêÏù¥ Ï†ÅÍµ∞Ïù¥Í≥†, Ï†ÅÍµ∞ ÎßêÏù¥ Î≥¥Îìú ÏúÑÏóê ÏûàÎã§Î©¥ Ïû°Í∏∞ ÏãúÎèÑ
                if (gameState.selectedPieceId) {
                    const currentTeamPieces = gameState.currentTurn === 'red' ? gameState.redPieces : gameState.bluePieces;
                    const selectedPiece = currentTeamPieces.find(p => p.id === gameState.selectedPieceId);
                    
                    if (selectedPiece && clickedPiece.location >= 0) {
                        // Ï†ÅÍµ∞ Îßê ÏúÑÏπòÎ°ú Ïù¥Îèô (Ïû°Í∏∞)
                        executeMove(clickedPiece.location);
                        return;
                    }
                }
                
                showToast(`ÏßÄÍ∏àÏùÄ ${gameState.currentTurn === 'red' ? 'Îπ®Í∞ÑÌåÄ' : 'ÌååÎûÄÌåÄ'} Ï∞®Î°ÄÏûÖÎãàÎã§.`);
                return;
            }

            // 2. Ïù¥ÎØ∏ ÏÑ†ÌÉùÎêú ÎßêÏù¥ ÏûàÎäî Í≤ΩÏö∞
            if (gameState.selectedPieceId) {
                // 2-1. ÏûêÍ∏∞ ÏûêÏã† ÌÅ¥Î¶≠ -> Ï∑®ÏÜå
                if (pieceId === gameState.selectedPieceId) {
                    gameState.selectedPieceId = null;
                    renderGame();
                    return;
                }

                // 2-2. Í∞ôÏùÄ ÌåÄ, Îã§Î•∏ Îßê ÌÅ¥Î¶≠ -> ÏóÖÍ∏∞ ÏãúÎèÑ
                // ÌÅ¥Î¶≠Îêú ÎßêÏù¥ Î≥¥Îìú ÏúÑÏóê ÏûàÏñ¥Ïïº Ìï® (ÎåÄÍ∏∞ÏÜåÎÇò ÏôÑÏ£º ÏÉÅÌÉúÍ∞Ä ÏïÑÎãàÏñ¥Ïïº Ìï®)
                if (clickedPiece.location >= 0) {
                    // Ïù¥Îèô Ïã§Ìñâ (ÏóÖÍ∏∞)
                    executeMove(clickedPiece.location);
                    return;
                }
                
                // 2-3. Í∑∏ Ïô∏ (ÎåÄÍ∏∞ÏÜåÏóê ÏûàÎäî Îã§Î•∏ Îßê ÌÅ¥Î¶≠ Îì±) -> ÏÑ†ÌÉù Î≥ÄÍ≤Ω
                gameState.selectedPieceId = pieceId;
                renderGame();
                return;
            }

            // 3. ÏÑ†ÌÉùÎêú ÎßêÏù¥ ÏóÜÎäî Í≤ΩÏö∞ -> ÏÑ†ÌÉù
            gameState.selectedPieceId = pieceId;
            
            // ÏÑ†ÌÉùÎêú ÎßêÍ≥º Í∞ôÏùÄ ÏúÑÏπòÏóê ÏûàÎäî ÎßêÎì§ÎèÑ Í∞ôÏù¥ ÏÑ†ÌÉùÎêú Ìö®Í≥º ÏïåÎ¶º
            if (clickedPiece.location !== -1 && clickedPiece.location !== -2) {
                const allies = pieces.filter(p => p.location === clickedPiece.location && p.id !== pieceId);
                if (allies.length > 0) {
                    showToast(`${allies.length + 1}Í∞úÏùò ÎßêÏù¥ Ìï®Íªò Ïù¥ÎèôÌï©ÎãàÎã§.`);
                }
            }
            renderGame();
        }

        function handleNodeClick(nodeIndex) {
            if (!gameState.selectedPieceId) return;
            executeMove(nodeIndex);
        }

        function executeMove(nodeIndex) {
            saveHistory(); // Ïù¥Îèô Ï†Ñ ÏÉÅÌÉú Ï†ÄÏû•

            const currentTeam = gameState.currentTurn;
            const pieces = currentTeam === 'red' ? gameState.redPieces : gameState.bluePieces;
            const enemyPieces = currentTeam === 'red' ? gameState.bluePieces : gameState.redPieces;
            
            const selectedPiece = pieces.find(p => p.id === gameState.selectedPieceId);
            if (!selectedPiece) return;

            // 0. Ïù¥ÎèôÌï† Îßê Í∑∏Î£π ÏÑ†Ï†ï (ÏóÖÍ∏∞ Î°úÏßÅ)
            let movingPieces = [selectedPiece];
            
            // ÎåÄÍ∏∞ÏÜå(-1)ÎÇò ÏôÑÏ£º(-2) ÏÉÅÌÉúÍ∞Ä ÏïÑÎãê ÎïåÎßå Í∞ôÏùÄ ÏúÑÏπòÏùò ÏïÑÍµ∞ÏùÑ Ï∞æÏùå
            if (selectedPiece.location !== -1 && selectedPiece.location !== -2) {
                const alliesAtCurrent = pieces.filter(p => 
                    p.location === selectedPiece.location && p.id !== selectedPiece.id
                );
                movingPieces = [...movingPieces, ...alliesAtCurrent];
            }

            // 1. Ïû°Í∏∞ Ï≤¥ÌÅ¨ (ÎèÑÏ∞©Ï†êÏùÄ Ï†úÏô∏)
            if (nodeIndex !== 29) {
                const enemiesAtTarget = enemyPieces.filter(p => p.location === nodeIndex);
                if (enemiesAtTarget.length > 0) {
                    enemiesAtTarget.forEach(p => {
                        p.location = -1; // ÎåÄÍ∏∞ÏÜåÎ°ú
                    });
                    showToast('ÏÉÅÎåÄ ÎßêÏùÑ Ïû°ÏïòÏäµÎãàÎã§! üéâ');
                }
            }

            // 2. Ïù¥Îèô Ï≤òÎ¶¨
            if (nodeIndex === 29) {
                // ÎèÑÏ∞©Ï†ê ÌÅ¥Î¶≠ Ïãú ÏôÑÏ£º Ï≤òÎ¶¨
                movingPieces.forEach(p => p.location = -2);
                showToast(movingPieces.length > 1 ? 'ÎßêÎì§Ïù¥ Ìï®Íªò ÏôÑÏ£ºÌñàÏäµÎãàÎã§! üèÅ' : 'ÎßêÏù¥ ÏôÑÏ£ºÌñàÏäµÎãàÎã§! üèÅ');
            } else {
                movingPieces.forEach(p => p.location = nodeIndex);
                
                // ÏóÖÍ∏∞ ÏïåÎ¶º (Ïù¥Îèô ÌõÑ Ìï¥Îãπ ÏúÑÏπòÏóê Îã§Î•∏ ÏïÑÍµ∞Ïù¥ ÏûàÏóàÏúºÎ©¥)
                // Î∞©Í∏à Ïù¥ÎèôÌïú Ïï†Îì§ Ï†úÏô∏ÌïòÍ≥†, Í∑∏ ÏûêÎ¶¨Ïóê ÏõêÎûò ÏûàÎçò ÏïÑÍµ∞Ïù¥ ÏûàÎäîÏßÄ Ï≤¥ÌÅ¨
                const existingAllies = pieces.filter(p => 
                    p.location === nodeIndex && !movingPieces.includes(p)
                );
                
                if (existingAllies.length > 0) {
                    showToast('ÎßêÏùÑ ÏóÖÏóàÏäµÎãàÎã§! üêé');
                }
            }
            
            gameState.selectedPieceId = null;
            renderGame();
        }

        function renderGame() {
            const board = document.getElementById('board');
            const turnDisplay = document.getElementById('turn-display');
            const teamRed = document.getElementById('team-red');
            const teamBlue = document.getElementById('team-blue');
            const waitingRed = document.getElementById('waiting-red');
            const finishedRed = document.getElementById('finished-red');
            const waitingBlue = document.getElementById('waiting-blue');
            const finishedBlue = document.getElementById('finished-blue');

            // ÌÑ¥ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
            if (gameState.currentTurn === 'red') {
                turnDisplay.innerText = "Îπ®Í∞ÑÌåÄ Ï∞®Î°Ä";
                turnDisplay.style.color = "var(--red-team)";
                turnDisplay.style.background = "#fff";
                teamRed.classList.add('active');
                teamBlue.classList.remove('active');
            } else {
                turnDisplay.innerText = "ÌååÎûÄÌåÄ Ï∞®Î°Ä";
                turnDisplay.style.color = "var(--blue-team)";
                turnDisplay.style.background = "#fff";
                teamRed.classList.remove('active');
                teamBlue.classList.add('active');
            }

            // Í∏∞Ï°¥ Îßê Ï†úÍ±∞
            document.querySelectorAll('.piece').forEach(el => el.remove());

            // Îßê Î†åÎçîÎßÅ
            const allPieces = [...gameState.redPieces, ...gameState.bluePieces];
            
            // Î†åÎçîÎßÅ ÏàúÏÑú: ÎåÄÍ∏∞/ÏôÑÏ£º Îßê -> Î≥¥Îìú ÏúÑ Îßê (ÏÑ†ÌÉùÎêú ÎßêÏùÄ Îß® ÎÇòÏ§ëÏóê)
            const sortedPieces = allPieces.sort((a, b) => {
                if (a.id === gameState.selectedPieceId) return 1;
                if (b.id === gameState.selectedPieceId) return -1;
                return 0;
            });

            // ÏúÑÏπòÎ≥ÑÎ°ú Í∑∏Î£πÌôîÌïòÏó¨ Í≤πÏπ® Ï≤òÎ¶¨
            const locationMap = {};
            sortedPieces.forEach(p => {
                if (!locationMap[p.location]) locationMap[p.location] = [];
                locationMap[p.location].push(p);
            });

            Object.keys(locationMap).forEach(loc => {
                const piecesAtLoc = locationMap[loc];
                const locationIndex = parseInt(loc);

                piecesAtLoc.forEach((piece, index) => {
                    const el = document.createElement('div');
                    el.className = `piece ${piece.team}`;
                    // ÏóÖÌûå Îßê Í∞ïÏ°∞ Ìö®Í≥º
                    const isSelected = piece.id === gameState.selectedPieceId;
                    const selectedPiece = allPieces.find(p => p.id === gameState.selectedPieceId);
                    const isGroupedWithSelected = selectedPiece && 
                                                selectedPiece.location === piece.location && 
                                                selectedPiece.team === piece.team &&
                                                locationIndex !== -1 && locationIndex !== -2;
                    
                    if (isSelected || isGroupedWithSelected) {
                        el.classList.add('selected');
                    }

                    
                    // ÏôÑÏ£ºÌïú ÎßêÏùÄ ÌÅ¥Î¶≠ Î∂àÍ∞Ä
                    if (locationIndex !== -2) {
                        el.onclick = (e) => handlePieceClick(piece.id, e);
                    } else {
                        el.style.opacity = "0.6";
                        el.style.cursor = "default";
                    }
                    
                    // Îßê Î≤àÌò∏ ÌëúÏãú (Í≥†Ïú† ID Í∏∞Î∞òÏúºÎ°ú Î≥ÄÍ≤ΩÌïòÏó¨ ÏùºÍ¥ÄÏÑ± Ïú†ÏßÄ)
                    const pieceNumber = parseInt(piece.id.substring(1)) + 1;
                    
                    // ÏïÑÏù¥ÏΩò Ï†ÅÏö©
                    const iconKey = piece.team === 'red' ? gameState.redIcon : gameState.blueIcon;
                    const iconChar = iconMap[iconKey];

                    if (iconChar) {
                        el.innerText = iconChar;
                        // Î≤àÌò∏Îäî ÏûëÍ≤å Î≥ÑÎèÑÎ°ú ÌëúÏãú
                        const numSpan = document.createElement('span');
                        numSpan.className = 'piece-num';
                        numSpan.innerText = pieceNumber;
                        el.appendChild(numSpan);
                    } else {
                        // Í∏∞Î≥∏ ÏõêÌòïÏùº ÎïåÎäî Í∑∏ÎÉ• Ïà´ÏûêÎßå ÌÅ¨Í≤å
                        el.innerText = pieceNumber;
                        el.style.fontSize = '12px';
                    }


                    if (locationIndex === -1) {
                        // ÎåÄÍ∏∞ÏÜå
                        el.style.position = 'relative';
                        el.style.transform = 'none';
                        el.style.margin = '2px';
                        if (piece.team === 'red') waitingRed.appendChild(el);
                        else waitingBlue.appendChild(el);
                    } else if (locationIndex === -2) {
                        // ÏôÑÏ£º
                        el.style.position = 'relative';
                        el.style.transform = 'none';
                        el.style.margin = '2px';
                        if (piece.team === 'red') finishedRed.appendChild(el);
                        else finishedBlue.appendChild(el);
                    } else {
                        // Î≥¥Îìú ÏúÑ
                        const pos = nodes[locationIndex];
                        if (pos) {
                            el.style.left = pos.x + '%';
                            el.style.top = pos.y + '%';
                            
                            // Í≤πÏπ® Ï≤òÎ¶¨
                            if (piecesAtLoc.length > 1) {
                                const offset = (index - (piecesAtLoc.length - 1) / 2) * 6;
                                el.style.transform = `translate(calc(-50% + ${offset}px), calc(-50% - ${index * 4}px))`;
                                if (piece.id === gameState.selectedPieceId) {
                                    el.style.transform += ' scale(1.3)';
                                }
                            }
                            board.appendChild(el);
                        }
                    }
                });
            });
        }

        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.className = "show";
            toast.innerText = message;
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }
    </script>
</body>
</html>